 





<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title> Facture Unique</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px;}
    h1 { text-align: center; color: #1428A0; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);}
    .form-group { margin-bottom: 12px; }
    label { display: block; margin-bottom: 4px; font-weight: bold; }
    input[type=text], input[type=number], input[type="date"] { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 8px; text-align: center; }
    th { background: #1428A0; color: #fff; }
    button { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; background: #1428A0; color: #fff; margin-top: 10px; }
    button:hover { background: #0f1f80; }
    .invoice-list { margin-top: 30px; }
    .invoice-list li { padding: 8px; border-bottom: 1px solid #ccc; cursor: pointer; }
    .invoice-list li:hover { background: #e6e6ff; }
    .total-display { font-size: 18px; font-weight: bold; margin-top: 10px; text-align: right; }
</style>
</head>
<body>

<h1> Facture Unique</h1>

<div class="container">
    <h2>Infos Facture</h2>
    <div class="form-group">
        <label>Numéro de Facture :</label>
        <input type="text" id="invoiceNumber" value="FACT-2024-001">
    </div>
    
    <div class="form-group">
        <label>Date de Facture :</label>
        <input type="date" id="invoiceDate">
    </div>
    
    <div class="form-group">
        <label>Taux TVA (%) :</label>
        <input type="number" id="tvaRate" value="18" min="0" max="100" step="0.1">
    </div>

    <h2>Infos Client</h2>
    <div class="form-group">
        <label>Nom du client :</label>
        <input type="text" id="clientName">
    </div>
    <div class="form-group">
        <label>Téléphone :</label>
        <input type="text" id="clientPhone">
    </div>
    <div class="form-group">
        <label>Adresse :</label>
        <input type="text" id="clientAddress">
    </div>
    <div class="form-group">
        <label>Email :</label>
        <input type="text" id="clientEmail">
    </div>

    <h2>Produits</h2>
    <table id="productsTable">
        <thead>
            <tr>
                <th>Nom produit</th>
                <th>Quantité</th>
                <th>Prix unitaire</th>
                <th>Total</th>
                <th>Supprimer</th>
            </tr>
        </thead>
        <tbody id="productsBody">
            <tr>
                <td><input type="text" class="productName"></td>
                <td><input type="number" class="productQty" value="0" min="0"></td>
                <td><input type="number" class="productPrice" value="0" min="0"></td>
                <td class="productTotal">0</td>
                <td><button onclick="removeRow(this)">X</button></td>
            </tr>
        </tbody>
    </table>
    <button onclick="addRow()">Ajouter un produit</button>
    
    <div class="total-display">
        <div>Sous-total: <span id="subTotal">0</span> FCFA</div>
        <div id="tvaDisplay">TVA (18%): <span id="tvaAmount">0</span> FCFA</div>
        <div><strong>Total TTC: <span id="totalTTC">0</span> FCFA</strong></div>
        <div id="totalInLetters" style="
        margin-top: 10px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 5px;
        font-style: italic;
        text-align: center;
        border-left: 4px solid #1428A0;
    "></div>
    </div>
    
    <button onclick="generateInvoice()">Générer le PDF</button>

    <div class="invoice-list">
        <h2>Factures enregistrées</h2>
        <ul id="invoiceList"></ul>
    </div>
</div>

<script>
const { jsPDF } = window.jspdf;

  // Fonction de conversion nombre en lettres
// Fonction de conversion nombre en lettres (version simplifiée et fiable)
function numberToLetters(num) {
    num = Math.round(num);
    
    // Tableaux pour la conversion
    const units = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
    const teens = ['dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
    const tens = ['', 'dix', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante-dix', 'quatre-vingt', 'quatre-vingt-dix'];
    
    if (num === 0) return 'zéro francs CFA';
    
    let result = '';
    
    // Fonction pour convertir les nombres < 1000
    function convertLessThanThousand(n) {
        let str = '';
        
        // Centaines
        if (n >= 100) {
            const hundreds = Math.floor(n / 100);
            if (hundreds === 1) {
                str += 'cent';
            } else {
                str += units[hundreds] + ' cent';
            }
            n %= 100;
            if (n > 0) str += ' ';
        }
        
        // 80 cas spécial
        if (n === 80) {
            return str + 'quatre-vingts';
        }
        
        // Dizaines et unités
        if (n >= 20) {
            const tensDigit = Math.floor(n / 10);
            const unitsDigit = n % 10;
            
            if (tensDigit === 7 || tensDigit === 9) {
                // Cas spéciaux
                const base = tensDigit === 7 ? 60 : 80;
                const remainder = n - base;
                
                str += (tensDigit === 7 ? 'soixante' : 'quatre-vingt');
                
                if (remainder > 0) {
                    if (remainder === 1) {
                        str += '-et-un';
                    } else if (remainder === 11) {
                        str += '-onze';
                    } else if (remainder < 10) {
                        str += '-' + units[remainder];
                    } else {
                        str += '-' + teens[remainder - 10];
                    }
                } else if (tensDigit === 8) {
                    str += 's';
                }
            } else {
                str += tens[tensDigit];
                if (unitsDigit > 0) {
                    if (unitsDigit === 1 && tensDigit !== 8) {
                        str += '-et-un';
                    } else {
                        str += '-' + units[unitsDigit];
                    }
                } else if (tensDigit === 8) {
                    str += 's';
                }
            }
        } else if (n >= 10) {
            str += teens[n - 10];
        } else if (n > 0) {
            str += units[n];
        }
        
        return str.trim();
    }
    
    // Convertir par tranches
    if (num >= 1000000) {
        const millions = Math.floor(num / 1000000);
        result += convertLessThanThousand(millions) + (millions > 1 ? ' millions ' : ' million ');
        num %= 1000000;
    }
    
    if (num >= 1000) {
        const thousands = Math.floor(num / 1000);
        if (thousands === 1) {
            result += 'mille ';
        } else {
            result += convertLessThanThousand(thousands) + ' mille ';
        }
        num %= 1000;
    }
    
    if (num > 0) {
        if (result !== '') result += ' ';
        result += convertLessThanThousand(num);
    }
    
    return result.trim() + ' francs CFA';
}
// --- Gestion dynamique des produits ---
function addRow() {
    const tbody = document.getElementById('productsBody');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td><input type="text" class="productName"></td>
        <td><input type="number" class="productQty" value="0" min="0"></td>
        <td><input type="number" class="productPrice" value="0" min="0"></td>
        <td class="productTotal">0</td>
        <td><button onclick="removeRow(this)">X</button></td>
    `;
    tbody.appendChild(row);
    updateTotals();
}

function removeRow(btn) {
    btn.closest('tr').remove();
    updateTotals();
}

function updateTotals() {
    let sousTotal = 0;
    
    // Calcul du sous-total
    document.querySelectorAll('#productsBody tr').forEach(row => {
        const qty = parseFloat(row.querySelector('.productQty').value) || 0;
        const price = parseFloat(row.querySelector('.productPrice').value) || 0;
        const total = qty * price;
        row.querySelector('.productTotal').textContent = total;
        sousTotal += total;
    });
    
    // Récupérer le taux TVA personnalisé
    const tvaRate = parseFloat(document.getElementById('tvaRate').value) || 0;
    const tva = sousTotal * (tvaRate / 100);
    const totalTTC = sousTotal + tva;
    
    // Mettre à jour l'affichage TVA
    const tvaDisplay = document.getElementById('tvaDisplay');
    tvaDisplay.innerHTML = `TVA (${tvaRate}%): <span id="tvaAmount">${formatNumber(tva)}</span> FCFA`;
    
    // Affichage
    document.getElementById('subTotal').textContent = formatNumber(sousTotal);
    document.getElementById('totalTTC').textContent = formatNumber(totalTTC);
    
    // AJOUTEZ CES DEUX LIGNES POUR AFFICHER EN LETTRES
    const totalInLetters = document.getElementById('totalInLetters');
    totalInLetters.textContent = `Arrêté à la somme de: ${numberToLetters(Math.round(totalTTC))}`;
}

// Calcul automatique
document.addEventListener('input', e => {
    if(e.target.classList.contains('productQty') || e.target.classList.contains('productPrice')) {
        updateTotals();
    }
});

// Formater les nombres
function formatNumber(number) {
    return Math.round(number).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
}

// --- Gestion des factures ---
function generateInvoice() {
    // Récupérer les nouvelles informations
    const invoiceNumber = document.getElementById('invoiceNumber').value || "FACT-" + Date.now();
    const invoiceDate = document.getElementById('invoiceDate').value || new Date().toISOString().split('T')[0];
    const tvaRate = parseFloat(document.getElementById('tvaRate').value) || 0;
    
    const client = {
        name: document.getElementById('clientName').value || "",
        phone: document.getElementById('clientPhone').value || "",
        address: document.getElementById('clientAddress').value || "",
        email: document.getElementById('clientEmail').value || ""
    };

    const items = [];
    document.querySelectorAll('#productsBody tr').forEach(row => {
        items.push({
            name: row.querySelector('.productName').value || "",
            quantity: parseFloat(row.querySelector('.productQty').value) || 0,
            price: parseFloat(row.querySelector('.productPrice').value) || 0
        });
    });

    const sousTotal = items.reduce((sum, i) => sum + i.quantity * i.price, 0);
    const tva = sousTotal * (tvaRate / 100);
    const totalTTC = sousTotal + tva;
    
    // CRÉER L'OBJET ORDER AVEC TOUTES LES DONNÉES
    const order = { 
        customer: client, 
        items, 
        sousTotal,    // Calculé ici
        tva,          // Calculé ici  
        totalTTC,     // Calculé ici
        tvaRate,      // Le taux de TVA (peut être 0)
        invoiceNumber, 
        date: invoiceDate,
        generatedDate: new Date().toISOString()
    };

    // Sauvegarder localement
    const saved = JSON.parse(localStorage.getItem('invoices') || '[]');
    saved.push(order);
    localStorage.setItem('invoices', JSON.stringify(saved));
    displayInvoices();

    // Générer PDF avec l'objet order COMPLET
    downloadInvoice(order);
}

function displayInvoices() {
    const saved = JSON.parse(localStorage.getItem('invoices') || '[]');
    const ul = document.getElementById('invoiceList');
    ul.innerHTML = '';
    saved.forEach(order => {
        const li = document.createElement('li');
        li.textContent = `Facture ${order.invoiceNumber} - ${order.date} - Total: ${formatNumber(order.totalTTC)} FCFA`;
        li.onclick = () => {
            showInvoiceDetails(order);
        };
        ul.appendChild(li);
    });
}

function showInvoiceDetails(order) {
    let detail = `Facture N°: ${order.invoiceNumber}\nDate: ${order.date}\nClient: ${order.customer.name}\nTéléphone: ${order.customer.phone}\nEmail: ${order.customer.email || ''}\nAdresse: ${order.customer.address}\n\nProduits:\n`;
    order.items.forEach((i, idx) => {
        detail += `${idx+1}. ${i.name} | Qté: ${i.quantity} | Prix: ${i.price} FCFA | Total: ${i.price*i.quantity} FCFA\n`;
    });
    detail += `\nSous-total: ${formatNumber(order.sousTotal)} FCFA\nTVA (${order.tvaRate}%): ${formatNumber(order.tva)} FCFA\nTotal TTC: ${formatNumber(order.totalTTC)} FCFA`;
    if(confirm(detail + "\n\nCliquez sur OK pour régénérer le PDF ?")) {
        downloadInvoice(order);
    }
}

// --- Génération PDF ---
// --- GÉNÉRATION PDF V2 – Ultra Chic, Moderne, Clair & Futuriste (fond blanc, tout noir texte principal) ---
function downloadInvoice(order) {
    const pdf = new jsPDF('p', 'mm', 'a4');
    let y = 12; // Plus d'espace en haut pour élégance

    // Couleurs ultra propres : presque tout en noir, un seul accent bleu clair moderne
    const textColor      = [0, 0, 0];       // Noir pur pour tout texte important
    const accentBlue = [212, 175, 55];    // Bleu électrique clair, discret et futuriste
    const lightGray      = [220, 220, 220]; // Très léger pour lignes / footer

    pdf.setFont('helvetica', 'normal'); // Base clean

    // === HEADER TRÈS VISIBLE – Logo + Nom entreprise en grand ===
    try {
        pdf.addImage("https://i.postimg.cc/Ss21d9Rp/LOGO.png", "PNG", 12, y - 2, 48, 48); // Logo plus grand
    } catch(e) {
        console.log("Logo non chargé");
    }

    pdf.setFontSize(22);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...textColor);
    pdf.text("ETS NIASS & FRÈRE", 70, y + 18);

    pdf.setFontSize(11);
    pdf.setFont('helvetica', 'normal');
    pdf.text("Réparation – Pièces détachées – Vente & Location de véhicules", 70, y + 26);

    // FACTURE à droite – Très grand et bold
    pdf.setFontSize(28);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...accentBlue);
    pdf.text("FACTURE", 195, y + 18, { align: 'right' });

    pdf.setFontSize(11);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...textColor);
    pdf.text(`N° ${order.invoiceNumber}`, 195, y + 26, { align: 'right' });
    pdf.text(`Date ${order.date}`, 195, y + 32, { align: 'right' });

    y += 48; // Grand espace après header

    // Ligne vague subtile (simulée avec plusieurs petites lignes) – effet futuriste léger
    pdf.setDrawColor(...accentBlue);
    pdf.setLineWidth(0.5);
    pdf.line(12, y, 198, y);
    pdf.setDrawColor(...lightGray);
    pdf.line(12, y + 1.2, 198, y + 1.2);

    y += 12;

    // === CLIENT – Style carte minimaliste chic ===
    pdf.setFontSize(13);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...textColor);
    pdf.text("FACTURÉ À", 12, y);

    pdf.setLineWidth(0.4);
    pdf.setDrawColor(...accentBlue);
    pdf.line(12, y + 2, 50, y + 2); // Petite underline accentuée

    y += 8;
    pdf.setFont('helvetica', 'normal');
    pdf.setFontSize(11);

    if (order.customer.name)    pdf.text(order.customer.name.toUpperCase(), 12, y);
    y += 6;
    if (order.customer.phone)   pdf.text(order.customer.phone, 12, y);
    y += 6;
    if (order.customer.email)   pdf.text(order.customer.email, 12, y);
    y += 6;
    if (order.customer.address) pdf.text(order.customer.address, 12, y);

    y += 18;

    // === TABLEAU PRODUITS – Header transparent + bordures fines bleues ===
    pdf.setFillColor(245, 245, 248); // Très très clair
    pdf.rect(12, y, 186, 9, 'F');

    pdf.setFontSize(10);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...accentBlue);
    pdf.text("DESCRIPTION", 16, y + 6.5);
    pdf.text("PRIX UNITAIRE", 98, y + 6.5, { align: 'right' });
    pdf.text("QTÉ", 138, y + 6.5, { align: 'right' });
    pdf.text("TOTAL", 188, y + 6.5, { align: 'right' });

    y += 9;
    pdf.setDrawColor(...lightGray);
    pdf.setLineWidth(0.3);

    pdf.setTextColor(...textColor);
    pdf.setFont('helvetica', 'normal');

    order.items.forEach(item => {
        if (y > 245) {
            pdf.addPage();
            y = 20;
        }

        const descLines = pdf.splitTextToSize(item.name || "", 75);
        const rowH = Math.max(8, descLines.length * 5.5);

        pdf.text(descLines, 16, y + 5);
        pdf.text(`${formatNumber(item.price)} FCFA`, 98, y + 5, { align: 'right' });
        pdf.text(item.quantity.toString(), 138, y + 5, { align: 'right' });
        pdf.text(`${formatNumber(item.price * item.quantity)} FCFA`, 188, y + 5, { align: 'right' });

        y += rowH;
        pdf.line(12, y, 198, y); // Ligne fine grise
    });

    y += 12;

    // === TOTAUX – Encadré léger chic, aligné droite ===
    pdf.setDrawColor(...accentBlue);
    pdf.setLineWidth(0.6);
    pdf.roundedRect(110, y, 88, order.tva > 0 ? 28 : 20, 4, 4, 'D'); // Cadre dashed subtil

    pdf.setFont('helvetica', 'bold');
    pdf.setFontSize(11);
    pdf.text("Sous-total", 140, y + 8, { align: 'right' });
    pdf.text(`${formatNumber(order.sousTotal)} FCFA`, 188, y + 8, { align: 'right' });

    let ty = y + 15;
    if (order.tva > 0) {
        pdf.text(`TVA ${order.tvaRate}%`, 140, ty, { align: 'right' });
        pdf.text(`${formatNumber(order.tva)} FCFA`, 188, ty, { align: 'right' });
        ty += 7;
    }

    pdf.setFontSize(12);
    pdf.text("TOTAL TTC", 140, ty, { align: 'right' });
    pdf.setTextColor(...accentBlue);
    pdf.text(`${formatNumber(order.totalTTC)} FCFA`, 188, ty, { align: 'right' });

    y = ty + 18;

    // === MONTANT EN LETTRES – Italique élégant, grand espace ===
    pdf.setFont('helvetica', 'italic');
    pdf.setFontSize(10);
    pdf.setTextColor(...textColor);
    const words = numberToLetters(Math.round(order.totalTTC));
    const lines = pdf.splitTextToSize(`Arrêté à la somme de : ${words}`, 180);
    pdf.text(lines, 12, y + 5);

    y += lines.length * 6 + 18;

    // === SIGNATURE – Centrée ou droite, avec style premium ===
    try {
        const sigUrl = "https://i.postimg.cc/PJhQ4P0f/LOCATION-VENTEDEVEHICULES-PIECESDERECHANGE-REPARATION-2.png";
        pdf.addImage(sigUrl, "PNG", 130, y, 65, 28);
        pdf.setFont('helvetica', 'normal');
        pdf.setFontSize(9);
        pdf.text("Signature", 162, y + 34, { align: 'center' });
    } catch(e) {
        pdf.setFontSize(11);
        pdf.text("Signature", 160, y + 10, { align: 'center' });
    }

    // Footer discret en gris très clair
    const pageH = pdf.internal.pageSize.getHeight();
    pdf.setFontSize(8);
    pdf.setTextColor(0, 0, 0);  // noir pur
    pdf.text("Route de Sangalkam près de la station de pesage – Sénégal", 105, pageH - 22, { align: 'center' });
    pdf.text("Tél : +221 70 878 19 89 – 77 470 47 42   |   Email : etsiniasseetfreres@yahoo.com", 105, pageH - 16, { align: 'center' });
    pdf.text("Compte CORISBANK SN213 01018 005058724101 42 – NINEA 004119964 – RCCM SN THS 2009.A.2320", 105, pageH - 10, { align: 'center' });

    pdf.save(`Facture-${order.invoiceNumber}.pdf`);
}

// Initialiser les valeurs par défaut
function initializeForm() {
    // Date du jour par défaut
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];
    document.getElementById('invoiceDate').value = formattedDate;
    
    // Générer un numéro de facture automatique
    const saved = JSON.parse(localStorage.getItem('invoices') || '[]');
    const lastNumber = saved.length;
    const year = today.getFullYear();
    document.getElementById('invoiceNumber').value = `FACT-${year}-${(lastNumber + 1).toString().padStart(3, '0')}`;
    
    // Écouter les changements de TVA
    document.getElementById('tvaRate').addEventListener('input', updateTotals);
    
    // Écouter les changements de quantité et prix
    document.addEventListener('input', e => {
        if(e.target.classList.contains('productQty') || e.target.classList.contains('productPrice')) {
            updateTotals();
        }
    });
    
    // Initialiser les totaux
    updateTotals();
}

// Démarrer l'application
document.addEventListener('DOMContentLoaded', function() {
    // Afficher les factures existantes
    displayInvoices();
    
    // Initialiser le formulaire
    initializeForm();
    
    // Mettre à jour les totaux initialement
    updateTotals();
});
</script>
</body>
</html>










