 

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>G√©n√©rateur de Bon de Livraison</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>
    :root{--bg:#f6fbff;--blue1:#0f4ac8;--blue2:#1a67ff;--muted:#666}
    *{box-sizing:border-box;font-family:'Inter',system-ui,Segoe UI,Roboto,Arial}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#fff);color:#102a43}
    .container{max-width:1100px;margin:28px auto;padding:24px}
    header{position:relative;background:white;padding:22px;border-radius:16px;overflow:visible;box-shadow:0 6px 30px rgba(12,40,120,0.08)}
    /* curved blues */
    header::before, header::after{content:"";position:absolute;border-radius:50%;z-index:0}
    header::before{width:420px;height:300px;background:radial-gradient(circle at 20% 20%,var(--blue1),transparent 40%);left:-120px;top:40px;transform:rotate(-20deg);opacity:0.95}
    header::after{width:360px;height:220px;background:radial-gradient(circle at 80% 80%,var(--blue2),transparent 40%);right:-80px;bottom:0;transform:rotate(10deg);opacity:0.95}
    .header-inner{position:relative;z-index:2;display:flex;gap:20px}
    .logo{margin-left:auto}
    .logo img{width:120px;height:120px;object-fit:cover;border-radius:0;display:block}
    .company-info{position:absolute;right:20px;top:20px;text-align:right;max-width:320px}
    .company-info strong{display:block}

    form{margin-top:8px;display:grid;grid-template-columns:1fr 360px;gap:18px;position:relative;z-index:2}
    .left{background:#fff;padding:18px;border-radius:12px}
    .right{background:#fff;padding:18px;border-radius:12px;height:100%}

    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type=text],input[type=number],select,textarea{width:100%;padding:10px;border:1px solid #e5eefc;border-radius:8px;font-size:15px}
    .radio-group{display:flex;gap:12px;align-items:center}
    .small{font-size:13px;color:var(--muted)}

    .table-wrap{margin-top:12px;overflow:auto}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e5eefc}
    th,td{padding:10px;border-bottom:1px solid #eef4ff;text-align:left}
    th{background:linear-gradient(90deg,var(--blue1),var(--blue2));color:white;font-weight:600}
    .actions{display:flex;gap:8px}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:10px;border:0;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--blue1),var(--blue2));color:white}
    .btn-ghost{background:transparent;border:1px solid #dbeafe;color:var(--blue1)}

    .bottom{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
    .devis-list{margin-top:18px;background:#fff;padding:12px;border-radius:12px}
    .devis-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #f1f7ff}
    .muted{color:var(--muted)}

    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}

    /* responsive */
    @media(max-width:980px){form{grid-template-columns:1fr} .company-info{position:static;text-align:left;margin-top:12px}}
    .devis-date-header {
    position: absolute;
    top: 110px;
    left: 20px;
    z-index: 3;
    color: white;
    font-size: 12px;
    background: rgba(0, 0, 0, 0.2);
    padding: 4px 8px;
    border-radius: 4px;
}
    @media (max-width: 640px) {
    .company-info {
        max-width: 55%;
        font-size: 10px;
    }
    
    .company-name {
        font-size: 14px;
    }
    
    .devis-info {
        top: 150px;
        right: 10px;
        font-size: 10px;
        padding: 8px;
    }
    
    .devis-number {
        font-size: 14px;
    }
    
    .client-info {
        margin-top: 80px;
        margin-left: 10px;
        margin-right: 10px;
        padding: 10px;
    }
    
    .container {
        padding-left: 10px;
        padding-right: 10px;
    }
    
    .logo-container {
        width: 80px;
        height: 80px;
        top: 15px;
        right: 15px;
    }
    
    .devis-date-header {
        top: 100px;
        font-size: 10px;
    }
    
    /* Ajustements pour les tableaux */
    .table-container {
        overflow-x: auto;
        font-size: 12px;
    }
    
    table {
        font-size: 12px;
    }
    
    th, td {
        padding: 4px 8px;
    }
    
    /* Ajustements pour les formulaires */
    input, select {
        font-size: 14px; /* √âvite le zoom sur iOS */
    }
}
    /* ===== CORRECTION DU D√âFILEMENT HORIZONTAL ===== */
@media (max-width: 768px) {
  body, html {
    overflow-x: hidden;
    width: 100%;
    position: relative;
  }
  
  .container {
    width: 100%;
    max-width: 100%;
    padding: 10px;
    margin: 0;
    box-sizing: border-box;
  }
  
  header {
    width: 100%;
    box-sizing: border-box;
  }
  
  .header-inner {
    flex-direction: column;
    width: 100%;
  }
  
  form {
    width: 100%;
    display: flex;
    flex-direction: column;
  }
  
  .left, .right {
    width: 100%;
    box-sizing: border-box;
  }
  
  /* Correction sp√©cifique pour les √©l√©ments qui d√©passent */
  .logo {
    max-width: 100%;
  }
  
  .logo img {
    max-width: 100%;
    height: auto;
  }
  
  /* Forcer le tableau √† s'adapter */
  .table-wrap {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  table {
    width: 100%;
    min-width: 100%;
    table-layout: fixed;
  }
  
  th, td {
    word-wrap: break-word;
  }
  
  /* Ajustements des inputs */
  input[type="text"], 
  input[type="number"], 
  select, 
  textarea {
    max-width: 100%;
    box-sizing: border-box;
  }
  
  /* Correction des flexbox qui d√©passent */
  .left > div[style*="display:flex"] {
    flex-wrap: wrap;
    width: 100%;
  }
  
  .left > div[style*="display:grid"] {
    grid-template-columns: 1fr;
    width: 100%;
  }
  
  /* Elements absolus qui pourraient d√©passer */
  .company-info {
    position: relative;
    width: 100%;
    text-align: center;
    margin-top: 10px;
  }
  
  .devis-date-header {
    position: relative;
    top: 0;
    left: 0;
    margin: 10px 0;
    width: 100%;
    text-align: center;
  }
}

/* Correction suppl√©mentaire pour tr√®s petits √©crans */
@media (max-width: 480px) {
  table {
    font-size: 12px;
  }
  
  th, td {
    padding: 6px 4px;
  }
  
  .btn {
    padding: 10px;
    font-size: 13px;
  }
  
  input[type="text"], 
  input[type="number"], 
  select, 
  textarea {
    font-size: 14px;
    padding: 10px;
  }
}

/* Styles pour le tableau simplifi√© */
#itemsTable th:nth-child(1),
#itemsTable td:nth-child(1) {
  width: 80%;
}

#itemsTable th:nth-child(2),
#itemsTable td:nth-child(2) {
  width: 20%;
}

/* Style pour le texte service */
.service-text {
  margin: 15px 0 10px 0;
  font-weight: 600;
}

.service-text.underline {
  text-decoration: underline;
}

/* Style pour la signature */
.signature-section {
  margin-top: 20px;
  display: flex;
  justify-content: space-between;
  padding-top: 10px;
  border-top: 1px solid #e5eefc;
}

.signature-box {
  text-align: center;
  width: 45%;
}

.signature-line {
  margin-top: 40px;
  border-top: 1px solid #000;
  width: 100%;
}

/* Style pour les informations de contact */
.contact-info {
  font-size: 8px;
  text-align: center;
  margin-top: 10px;
  line-height: 1.2;
}

.contact-info span {
  display: inline-block;
  margin: 0 5px;
}

/* Style pour le tampon */
.tampon {
  margin-top: 10px;
  text-align: center;
}

.tampon img {
  max-width: 120px;
  height: auto;
}

  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-inner">
        <div>
          <h1 style="margin:0;font-size:20px">BON DE LIVRAISON</h1>
         </div>
        <div class="logo" title="Logo">
          <img src="https://i.postimg.cc/gks2dpjN/photo-6046262394910084604-y.jpg" alt="logo">
        </div>
      </div>

     

    </header>

    <form id="devisForm">
      <div class="left">
       <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
  <div style="min-width:200px">
    <label>Num√©ro BON DE LIVRAISON</label>
    <input type="text" id="numDevis" placeholder=" " required>
  </div>
  <div style="min-width:200px">
    <label>Date </label>
    <input type="date" id="dateDevis">
  </div>
</div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
          <div>
            <label>Nom</label>
            <input type="text" id="nomClient" placeholder=" ">
          </div>
          <div>
            <label>Matricule</label>
            <input type="text" id="matricule" placeholder=" ">
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Service</label>
          <input type="text" id="service" placeholder=" ">
        </div>
<div style="margin-top:12px">
  <label> </label>
  <input type="text" id="nomClient" placeholder="NE RIEN ECRIRE ICI">
</div>
        <div class="table-wrap">
          <table id="itemsTable">
            <thead>
              <tr><th>D√©signation</th><th>Quantit√©</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <button type="button" class="btn btn-ghost" id="addRow">‚ûï Ajouter une ligne</button>
          <div class="muted" style="margin-left:auto"> </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button type="button" class="btn btn-primary" id="generatePdf">G√©n√©rer</button>
          <button type="button" class="btn" id="saveDevis"> Sauvegarder</button>
          <button type="button" class="btn" id="clearForm">Effacer</button>
        </div>
      </div>

      <div class="right">
        <h3 style="margin-top:0">Liste des Bons de Livraison</h3>
        <div class="devis-list" id="devisList"></div>
       
      </div>
    </form>

    <footer> LUXUARY CAR </footer>
  </div>

  <!-- Librairies JS pour PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    // Utils
       // Utils
    const $ = id => document.getElementById(id);
    const qs = sel => document.querySelector(sel);

    // ========== FIREBASE INITIALIZATION ==========
    // Votre configuration Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAtDX1KtShdZS4BOFE6H8cVmHtvMW8bZUA",
        authDomain: "senegalluxuarycar.firebaseapp.com",
        projectId: "senegalluxuarycar",
        storageBucket: "senegalluxuarycar.firebasestorage.app",
        messagingSenderId: "41469168124",
        appId: "1:41469168124:web:e2b709e581dc2b3e598a79",
        measurementId: "G-KPQGNWN6QD"
    };

    // Initialiser Firebase
    try {
        firebase.initializeApp(firebaseConfig);
    } catch (error) {
        console.log("Firebase d√©j√† initialis√© ou erreur:", error);
    }

    // R√©f√©rences Firestore
    const db = firebase.firestore();
    const bonsDeLivraisonCollection = db.collection("bonsDeLivraison");

    // ========== FIREBASE AUTH ==========
    let currentUser = null;

    // Fonction de connexion anonyme (pour garder les donn√©es priv√©es)
    async function signInAnonymously() {
        try {
            const userCredential = await firebase.auth().signInAnonymously();
            currentUser = userCredential.user;
            console.log("Connect√© anonymement:", currentUser.uid);
            return currentUser;
        } catch (error) {
            console.error("Erreur de connexion anonyme:", error);
            // Fallback sur localStorage
            return null;
        }
    }

    // V√©rifier l'√©tat d'authentification au chargement
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            console.log("Utilisateur connect√©:", user.uid);
            // Charger les donn√©es depuis Firebase
            loadDevisList();
        } else {
            // Essayer de se connecter anonymement
            signInAnonymously();
        }
    });

    // Table management
    const tbody = document.querySelector('#itemsTable tbody');
    function addRow(data={designation:'',qty:1}){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class='inp des' value="${escapeHtml(data.designation)}" placeholder='D√©signation'></td>
        <td><input class='inp qty' type='number' min='0' value='${data.qty}'></td>
        <td><button class='btn btn-ghost btn-sm del'>Suppr</button></td>
      `;
      tbody.appendChild(tr);
      hookRow(tr);
    }

    function escapeHtml(str){ return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function hookRow(tr){
      const qty = tr.querySelector('.qty');
      const des = tr.querySelector('.des');
      const del = tr.querySelector('.del');
      function update(){
        // Pas de calculs n√©cessaires pour le bon de livraison
      }
      qty.addEventListener('input', update);
      des.addEventListener('input', ()=>{});
      del.addEventListener('click', ()=>{ tr.remove(); });
    }

    // Events
    document.getElementById('addRow').addEventListener('click', ()=>addRow());
    
    document.getElementById('clearForm').addEventListener('click', ()=>{
      if(confirm('R√©initialiser le formulaire ?')){ document.getElementById('devisForm').reset(); tbody.innerHTML=''; addRow(); }
    });

    
    
        // ========== NUM√âRO AUTOMATIQUE ==========
    async function getNextDevisNumber() {
        try {
            if (!currentUser) {
                await signInAnonymously();
            }
            
            // Chercher le dernier num√©ro de l'utilisateur
            const snapshot = await bonsDeLivraisonCollection
                .where("userId", "==", currentUser.uid)
                .orderBy("numDevis", "desc")
                .limit(1)
                .get();
            
            let lastNumber = 888; // Commence √† 888
            
            if (!snapshot.empty) {
                const lastDevis = snapshot.docs[0].data();
                if (lastDevis.numDevis && lastDevis.numDevis.startsWith("888")) {
                    // Extraire le nombre apr√®s "888"
                    const match = lastDevis.numDevis.match(/888(\d+)/);
                    if (match && match[1]) {
                        lastNumber = 888 + parseInt(match[1]) + 1;
                    } else {
                        lastNumber = 888 + 1;
                    }
                }
            }
            
            return `888${lastNumber.toString().padStart(4, '0').slice(3)}`;
            
        } catch (error) {
            console.error("Erreur de r√©cup√©ration du num√©ro:", error);
            // Fallback : chercher dans le localStorage
            return getNextDevisNumberFromLocal();
        }
    }
    
    function getNextDevisNumberFromLocal() {
        const list = JSON.parse(localStorage.getItem('devis_list') || '[]');
        const cache = JSON.parse(localStorage.getItem('devis_cache') || '[]');
        const allItems = [...list, ...cache];
        
        // Filtrer les num√©ros qui commencent par 888
        const devisNumbers = allItems
            .filter(item => item.numDevis && item.numDevis.startsWith("888"))
            .map(item => {
                const match = item.numDevis.match(/888(\d+)/);
                return match ? parseInt(match[1]) : 0;
            })
            .filter(num => !isNaN(num))
            .sort((a, b) => b - a);
        
        const lastNum = devisNumbers.length > 0 ? devisNumbers[0] : 0;
        const nextNum = lastNum + 1;
        
        return `888${nextNum.toString().padStart(4, '0').slice(3)}`;
    }
    // PDF generation with jsPDF + autotable
    async function generatePDF(dataObj){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt',format:'a4'});
      const leftMargin = 40; const rightMargin = 40; const pageWidth = doc.internal.pageSize.getWidth();

      // Header: logo at top-right (square)
      const img = new Image(); img.crossOrigin = 'anonymous'; img.src = 'https://i.postimg.cc/gks2dpjN/photo-6046262394910084604-y.jpg';
      await new Promise(res=>{ img.onload = res; img.onerror = res; });
      const logoSize = 150; doc.addImage(img, 'JPEG', pageWidth - rightMargin - logoSize, 30, logoSize, logoSize);

      // Company info top-right under logo
      doc.setFontSize(14); doc.setFont('helvetica','bold'); doc.text(' ', pageWidth - rightMargin - 10, 140, {align:'right'});
      doc.setFontSize(10); doc.setFont('helvetica','normal');
      doc.text('  ', pageWidth - rightMargin - 10, 154, {align:'right'});
      doc.text('  ', pageWidth - rightMargin - 10, 168, {align:'right'});
      doc.text(' ', pageWidth - rightMargin - 10, 182, {align:'right'});
      
    // Date en haut √† gauche
if(dataObj.dateDevis) {
  const date = new Date(dataObj.dateDevis);
  const formattedDate = date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
  doc.setFontSize(11);
  doc.setFont('helvetica','normal');
  doc.text('Date: ' + formattedDate, leftMargin, 70);
}

// Titre (descendu pour cr√©er l‚Äôespace apr√®s la date)
doc.setFontSize(16);
doc.setFont('helvetica','bold');
doc.text('BON DE LIVRAISON ' + (dataObj.numDevis || ''), leftMargin, 105);

// Informations client (espac√© calmement)
doc.setFontSize(14);
doc.setFont('helvetica','normal');
doc.text('Nom: ' + (dataObj.nom || ''), leftMargin, 130);
doc.text('Matricule: ' + (dataObj.matricule || ''), leftMargin, 145);

// Service (descendu pour ajouter un espace visuel)
if(dataObj.service) {
  doc.setFont('helvetica','bold');
  doc.text('Service: ' + dataObj.service, leftMargin, 170);
  doc.setFont('helvetica','normal');
}


      // Items table
      const startY = 240;
      const columns = [
        {header:'D√©signation',dataKey:'des'},
        {header:'Quantit√©',dataKey:'qty'}
      ];
      doc.autoTable({
        startY, 
        head:[columns.map(c=>c.header)], 
        body: dataObj.items.map(it=>[it.des, it.qty]),
        styles:{fontSize:13}, 
        theme:'striped', 
        headStyles:{fillColor:[15,74,200]}, 
        margin:{left:leftMargin,right:rightMargin},
       columnStyles: {
  0: { cellWidth: 'auto' },
  1: { cellWidth: 100, halign: 'center' }
}
      });

      // Ligne de s√©paration
      const finalY = doc.lastAutoTable.finalY + 20;
      doc.setDrawColor(0);
      doc.setLineWidth(0.5);
      doc.line(leftMargin, finalY, pageWidth - rightMargin, finalY);

      // Section de signature
      const signatureY = finalY + 30;
      
      // Client √† gauche
doc.setFontSize(12);
      
doc.text(' ', leftMargin, signatureY);
doc.setFontSize(19);
doc.text('  ' + (dataObj.nomClient || ''), leftMargin, signatureY + 20); // ‚Üê NOM AJOUT√â ICI
doc.text('', leftMargin, signatureY + 40);
      // Garagiste √† droite
      doc.setFontSize(12);
      doc.text('Le Garagiste', pageWidth - rightMargin - 50, signatureY, {align: 'right'});
      doc.setFontSize(10);
      doc.text('', pageWidth - rightMargin - 50, signatureY + 40, {align: 'right'});
      
      // Tampon sous le garagiste
    // Tampon sous le garagiste
const tamponImg = new Image();
tamponImg.crossOrigin = 'anonymous';
tamponImg.src = 'https://i.postimg.cc/CL7k2WVW/Design-sans-titre-(3).png';

await new Promise(resolve => {
  tamponImg.onload = resolve;
  tamponImg.onerror = resolve;
});

// On choisit juste la largeur qu'on veut (ex: 140)
const newWidth = 170;

// La hauteur s'ajuste automatiquement selon l'image
const ratio = tamponImg.height / tamponImg.width;
const newHeight = newWidth * ratio;

// Ajout dans le PDF (sans d√©formation)
doc.addImage(
  tamponImg,
  'PNG',
  pageWidth - rightMargin - newWidth - 10, // Position horizontale
  signatureY + 40, // Position verticale
  newWidth,
  newHeight
);




      // Infos entreprise en bas centr√©
      const footerText = "RC-SN-DKR-2024-A-46119 T√©l : +221 77 480 09 30 - 78 896 19 48   |   Email : senegalluxuariecars@yahoo.com NINEA:0116573661";
      doc.setFontSize(9);
      doc.setFont('helvetica', 'italic');
      
      // Diviser le texte en deux parties
      const firstPart = "RC-SN-DKR-2024-A-46119 T√©l : +221 77 480 09 30 - 78 896 19 48";
      const secondPart = "Email : senegalluxuariecars@yahoo.com NINEA:0116573661";
      
      doc.text(firstPart, pageWidth / 2, doc.internal.pageSize.getHeight() - 40, { align: 'center' });
      doc.text(secondPart, pageWidth / 2, doc.internal.pageSize.getHeight() - 30, { align: 'center' });

      // Save / open
      doc.save((dataObj.numDevis||'bon-de-livraison') + '.pdf');
    }

    // Build data and call generate
    document.getElementById('generatePdf').addEventListener('click', async ()=>{
      const data = collectForm();
      await generatePDF(data);
    });
 
 function collectForm(){
  const nom = $('nomClient').value;
  const matricule = $('matricule').value;
  const numDevis = $('numDevis').value || '';
  const dateDevis = $('dateDevis').value;
  const service = $('service').value;
  const nomClient = $('nomClient').value; // ‚Üê AJOUTEZ CETTE LIGNE
  const items = [...tbody.querySelectorAll('tr')].map(r=>({des:r.querySelector('.des').value, qty:Number(r.querySelector('.qty').value)||0})).filter(i=>i.des||i.qty);
  return {nom,matricule,numDevis,dateDevis,service,nomClient,items}; // ‚Üê AJOUTEZ nomClient ici
}

    // Save devis to localStorage list
       // ========== FIREBASE DATABASE FUNCTIONS ==========
    
    // Sauvegarder un bon de livraison
    async function saveDevisToFirebase(data) {
        try {
            if (!currentUser) {
                await signInAnonymously();
            }
            
            // Ajouter l'ID utilisateur et la date de cr√©ation
            const devisData = {
                ...data,
                userId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            let docRef;
            if (data.id) {
                // Mettre √† jour un document existant
                docRef = await bonsDeLivraisonCollection.doc(data.id).update({
                    ...devisData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return data.id;
            } else {
                // Cr√©er un nouveau document
                docRef = await bonsDeLivraisonCollection.add(devisData);
                return docRef.id;
            }
        } catch (error) {
            console.error("Erreur de sauvegarde Firebase:", error);
            // Fallback sur localStorage
            saveToLocalStorage(data);
            return null;
        }
    }

    // Charger la liste des bons de livraison
    async function loadDevisList() {
        try {
            if (!currentUser) {
                await signInAnonymously();
            }
            
            // R√©cup√©rer les documents de l'utilisateur courant, tri√©s par date de cr√©ation
            const snapshot = await bonsDeLivraisonCollection
                .where("userId", "==", currentUser.uid)
                .orderBy("createdAt", "desc")
                .get();
            
            const list = [];
            snapshot.forEach(doc => {
                list.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            // Sauvegarder en cache local pour l'offline
            localStorage.setItem('devis_cache', JSON.stringify(list));
            
            return list;
        } catch (error) {
            console.error("Erreur de chargement Firebase:", error);
            // Charger depuis le cache local
            return loadFromLocalStorage();
        }
    }

    // Supprimer un bon de livraison
    async function deleteDevisFromFirebase(id) {
        try {
            await bonsDeLivraisonCollection.doc(id).delete();
            console.log("Document supprim√©:", id);
            return true;
        } catch (error) {
            console.error("Erreur de suppression:", error);
            // Essayer de supprimer du localStorage
            deleteFromLocalStorage(id);
            return false;
        }
    }

    // ========== FALLBACK LOCALSTORAGE FUNCTIONS ==========
    function saveToLocalStorage(data) {
        const list = JSON.parse(localStorage.getItem('devis_list') || '[]');
        const index = list.findIndex(item => item.numDevis === data.numDevis);
        
        if (index >= 0) {
            list[index] = data;
        } else {
            list.unshift(data);
        }
        
        localStorage.setItem('devis_list', JSON.stringify(list));
    }

    function loadFromLocalStorage() {
        const cache = localStorage.getItem('devis_cache');
        if (cache) return JSON.parse(cache);
        
        const list = localStorage.getItem('devis_list');
        return list ? JSON.parse(list) : [];
    }

    function deleteFromLocalStorage(id) {
        const list = JSON.parse(localStorage.getItem('devis_list') || '[]');
        const newList = list.filter(item => item.id !== id && item.numDevis !== id);
        localStorage.setItem('devis_list', JSON.stringify(newList));
        
        // Mettre √† jour le cache
        const cache = JSON.parse(localStorage.getItem('devis_cache') || '[]');
        const newCache = cache.filter(item => item.id !== id);
        localStorage.setItem('devis_cache', JSON.stringify(newCache));
    }

       async function renderDevisList() {
        const container = $('devisList'); 
        container.innerHTML = '<div class="muted">Chargement...</div>';
        
        try {
            const list = await loadDevisList();
            
            if (!list.length) { 
                container.innerHTML = '<div class="muted">Aucun bon de livraison enregistr√© ‚Äî commencez par remplir le formulaire et cliquez sur ¬´ Sauvegarder ¬ª</div>'; 
                return; 
            }
            
            container.innerHTML = '';
            list.forEach((d, idx) => {
                const el = document.createElement('div'); 
                el.className = 'devis-item';
                el.innerHTML = `
                    <div>
                        <strong>${escapeHtml(d.numDevis || 'Sans num√©ro')}</strong> ‚Äî ${escapeHtml(d.nom || '‚Äî')}
                        <div style="font-size: 11px; color: #666;">
                            ${d.dateDevis || ''}
                        </div>
                    </div>
                    <div class='actions'>
                        <button class='btn' data-action='edit' data-id='${d.id || idx}'>‚úèÔ∏è</button>
                        <button class='btn' data-action='pdf' data-id='${d.id || idx}'>üìÑ</button>
                        <button class='btn' data-action='delete' data-id='${d.id || idx}'>üóëÔ∏è</button>
                    </div>`;
                container.appendChild(el);
            });
            
            container.querySelectorAll('button').forEach(b => {
                b.addEventListener('click', async e => {
                    const act = b.getAttribute('data-action');
                    const id = b.getAttribute('data-id');
                    const list = await loadDevisList();
                    const devis = list.find(item => item.id === id || item.numDevis === id);
                    
                    if (act === 'delete') { 
                        if (confirm('Supprimer ce bon de livraison ?')) { 
                            await deleteDevisFromFirebase(id);
                            renderDevisList();
                        } 
                    }
                    if (act === 'edit' && devis) { 
                        populateForm(devis); 
                    }
                    if (act === 'pdf' && devis) { 
                        generatePDF(devis); 
                    }
                });
            });
        } catch (error) {
            console.error("Erreur de rendu:", error);
            container.innerHTML = '<div class="muted">Erreur de chargement</div>';
        }
    }

    function populateForm(d){
      $('numDevis').value = d.numDevis || '';
      $('nomClient').value = d.nom || '';
      $('matricule').value = d.matricule || '';
      $('service').value = d.service || '';
      tbody.innerHTML=''; (d.items||[]).forEach(it=>addRow(it));
    }

    document.getElementById('saveDevis').addEventListener('click', ()=>{
      const data = collectForm();
      const list = loadDevisList();
      // if same num exists replace
      const exist = list.findIndex(x=>x.numDevis===data.numDevis);
      if(exist>=0){ if(!confirm('Num√©ro de bon de livraison d√©j√† existant ‚Äî remplacer ?')) return; list[exist]=data; }
      else list.unshift(data);
      saveDevisList(list);
      alert('Bon de livraison sauvegard√© ‚úîÔ∏è');
    });
    
    // Initialiser la date avec la date du jour
    const today = new Date();
    const formattedDate = today.toISOString().substr(0, 10);
    $('dateDevis').value = formattedDate;
    
    // init
    addRow(); renderDevisList();
    
  </script>
</body>
</html>
